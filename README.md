<h2 align="center">ARES: An Automated Evaluation Framework for Retrieval-Augmented Generation Systems</h2>

<p align="center">
  <a href="http://tiny.cc/ares_rag" target="_blank">Read the ARES Paper</a>
</p>

<p align="center">
  <a href="https://colab.research.google.com/drive/1lc8Tkcair7wWZVbsdNKmfSM5rbAqOeeO#scrollTo=03609iqyArxM" target="_blank">
    <img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/>
  </a>
</p>

---

### Implementing ARES

To utilize ARES for evaluating your Retrieval-Augmented Generation (RAG) system, ensure you have:

- A **Human Preference Validation Set** ‚Äî Annotated query-document-answer triples assessing evaluation criteria (context relevance, answer faithfulness, and/or answer relevance), with a minimum of 50 examples (ideally several hundred).
- A **Few-Shot Example Set** ‚Äî Selected examples for scoring the context relevance, answer faithfulness, and/or answer relevance within your system.
- A **Large Unlabeled Data Set** ‚Äî A comprehensive collection of query-document-answer triples generated by your RAG system for scoring.

### ARES Training Pipeline

Follow these steps to prepare your RAG system for ARES scoring:

1. **Synthetic Data Generation** ‚Äî Create synthetic queries and answers from in-domain passages.
2. **LLM Judge Preparation** ‚Äî Fine-tune Large Language Model (LLM) judges on the synthetically-generated data to prepare for RAG system scoring.
3. **Evaluation Deployment** ‚Äî Assess your RAG system with the trained LLM judges, focusing on key performance metrics.


Note: We also allow users to skip Steps #1 and #2 deploying a zero/few-shot LLM-as-a-Judge
‚Äã
### ‚öôÔ∏è Installation
‚Äã
To install the necessary dependencies, run the following commands:
‚Äã
````
pip install ares-ai
````
‚Äã
Optional: Initalize OpenAI or TogetherAI API key with the following command:
````
export OPENAI_API_KEY=<your key here>
export TOGETHER_API_KEY=<your key here>
````

### üöÄ Quick Start

To get started with ARES, you'll need to set up your configuration. Below is is an example of how to structure your configuration for ARES.

```

from ares import ARES

synth_config = { 
    "document_filepaths": ["ARES/data/datasets_v2/nq/nq_ratio_0.5.tsv"],  # Path(s) to evaluation dataset files
    "few_shot_prompt_filename": "ARES/data/datasets/few_shot_prompt__v1.tsv",  # Path to file containing few-shot examples
    "synthetic_queries_filenames": ["data/synthetic_queries.tsv"], # Path to store synthetic queries
    "documents_sampled": 10000 
}

classifier_config = {
    "classification_dataset": ["data/synthetic_queries.tsv"], # Path containing synthetic queries
    "test_set_selection": "ARES/data/datasets_v2/nq/nq_ratio_0.6.tsv", # Path for test set selection
    "label_column": [Context_Relevance_Label], 
    "num_epochs": 10, 
    "patience_value": 3, 
    "learning_rate": 5e-6
}

ppi_config = { 
    "evaluation_datasets": ["ARES/data/datasets_v2/nq/nq_ratio_0.6.tsv"], # Path to evaluation dataset(s)
    "few_shot_examples_filepath": "ARES/data/datasets/few_shot_prompt__v1.tsv", # Path to file containing few-shot examples
    "checkpoints": ["ARES/data/checkpoints/Context_Relevance_Label_ratio_0.6_.pt"], # Path to checkpoint file
    "labels": [Context_Relevance_Label], 
    "GPT_scoring": False, 
    "gold_label_path": "ARES/data/gold_label_path.tsv", # Path to gold label path
    "swap_human_labels_for_gpt4_labels": False
}

ares_module = ARES(synthetic_query_generator=synth_config, classifier_model=classifier_config, ppi=ppi_config)
results = ares_module.run()
print(results)
```
‚Äã
## Step #1: Synthetic Data Generation
‚Äã
To generate synthetic training data, use `LLM-as-a-Judge_Adaptation/Generate_Synthetic_Queries_and_Answers.py`. Replace items in the following command with your dataset and configuration:
‚Äã
````
python LLM-as-a-Judge_Adaptation/Generate_Synthetic_Queries_and_Answers.py \
       --document_filepath <document_filepath> \
       --few_shot_prompt_filename <few_shot_prompt_filename> \
       --synthetic_queries_filename <synthetic_queries_filename> \
       --documents_sampled 10000
````

Example:
````
python LLM-as-a-Judge_Adaptation/Generate_Synthetic_Queries_and_Answers.py \
       --document_filepath example_files/document_filepath.tsv \
       --few_shot_prompt_filename example_files/few_shot_prompt_filename.tsv \
       --synthetic_queries_filename output/synthetic_queries_1.tsv \
       --documents_sampled 10000
````

This script will output a filepath to the generated synthetic queries for the next step.
‚Äã

Note: For examples files for `document_filepath` and `few_shot_prompt_filename`, please see `example_files`.
‚Äã
## Step #2: Fine-tune LLM-as-a-Judge
‚Äã
With the generated file under `synthetic_queries_filename` from the previous step, use `LLM-as-a-Judge_Adaptation/General_Binary_Classifier.py` to train your LLM-as-a-Judge with the following command:
‚Äã
````
python General_Binary_Classifier.py \
       --classification_dataset <synthetic queries file> \
       --test_set_selection <test_set_selection> \
       --label_column Context_Relevance_Label \
       --num_epochs 10 \
       --patience_value 3 \
       --learning_rate 5e-6
````

For `document_filepath`, put the filepath of the synthetic queries generated in the previous step. For `test_set_selection`, put the filepath of the human annotated examples of your dataset; it should be formatted like the file `example_files/evaluation_datasets.tsv`.

This script will output a model checkpoint path for the next step.


## Step #3: Score RAG System with ARES
‚Äã
With the outputted model checkpoint from Step #2, you can now score your RAG system's configurations using ARES with following command in folder `RAG_Automatic_Evaluation/`:
‚Äã
````
python LLMJudge_RAG_Compared_Scoring.py \
       --alpha 0.05 \
       --num_trials 1000 \
       --evaluation_datasets <evaluation_datasets as list> \
       --checkpoints <checkpoints as list> \
       --labels <label columns as list> \
       --GPT_scoring <True or False> \
       --gold_label_path <gold_label_path>
       --swap_human_labels_for_gpt_labels False
````
‚Äã
For `evaluation_datasets`, we expect a list of filepaths to query-passage-answer TSVs for each RAG configuration you wish to score.

If you want to use few-shot GPT scoring, switch `GPT_scoring` to `True`. You can leave the `checkpoints` list as blank and specify the GPT model with the tag `--gpt_model <model selected>`.
‚Äã

Note: For examples files of `evaluation_datasets` and `gold_label_path`, please see `example_files/evaluation_datasets.tsv` for formatting.

## Results Replication

We include synthetic datasets for key experimental results in `synthetic_datasets`. The few-shot prompts used for generation and evaluation are included in `datasets`. We also include instructions for fine-tuning LLM judges in the paper itself. Please reach out to jonsaadfalcon@stanford.edu or manihani@stanford.edu if you have any further questions.

## Citation

To cite our work, please use the following Bibtex:

````
@misc{saadfalcon2023ares,
      title={ARES: An Automated Evaluation Framework for Retrieval-Augmented Generation Systems}, 
      author={Jon Saad-Falcon and Omar Khattab and Christopher Potts and Matei Zaharia},
      year={2023},
      eprint={2311.09476},
      archivePrefix={arXiv},
      primaryClass={cs.CL}
}
````

# Appendix
### Machine requirements and setup when not using OpenAI API
**Machine requirements**

- Over ~100 GB of available disk space
- GPU
    - Should work: A100 (e.g. `Standard_NC24ads_A100_v4` on Azure)
    - Does not work:
        - Tested on 2023-12-17 with both `Standard_NC6s_v3` and `Standard_NC12s_v3`, and ran into this error: `torch.cuda.OutOfMemoryError: CUDA out of memory. Tried to allocate 160.00 MiB (GPU 0; 15.77 GiB total capacity; 15.12 GiB already allocated; 95.44 MiB free; 15.12 GiB reserved in total by PyTorch)`


**Machine setup**

For example, on an Azure VM running Linux (ubuntu 20.04), you will need to do the following:
- Install conda
    - First set of commands (can copy-paste multiple lines)
        - `wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh`
        - `chmod +x Miniconda3-latest-Linux-x86_64.sh`
        - `./Miniconda3-latest-Linux-x86_64.sh -b`
    - Second set of commands (can copy-paste multiple lines)
        - `export PATH="~/miniconda3/bin:$PATH"`
        - `conda init`
- Install gcc
    - `sudo apt-get -y update`
    - `sudo apt-get -y upgrade`
    - `sudo apt-get -y install build-essential`
    - `sudo apt-get -y install libpcre3-dev`
- Install NVIDIA drivers
    - `sudo apt install ubuntu-drivers-common -y`
    - `sudo ubuntu-drivers autoinstall`
    - `sudo reboot`
    - SSH in again and confirm the installation was successful by running `nvidia-smi`
- `cd` to ARES folder and follow the rest of the README
